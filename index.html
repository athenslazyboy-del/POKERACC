<script type="module">
    // 1. Import Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // 2. Firebase Config (ใช้ค่าเดิมของนาย)
    const firebaseConfig = {
        apiKey: "AIzaSyBLH6kay1-t5PLolNPzoRRT28WxJOs4jV8",
        authDomain: "pokeracc-b7732.firebaseapp.com",
        databaseURL: "https://pokeracc-b7732-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "pokeracc-b7732",
        storageBucket: "pokeracc-b7732.firebasestorage.app",
        messagingSenderId: "454101305838",
        appId: "1:454101305838:web:fa54b85d616a2ca8eaa6ff",
        measurementId: "G-8BRPSXWQTE"
    };

    // 3. Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // 4. ผูกฟังก์ชันเข้ากับ Window เพื่อให้ Alpine.js เรียกใช้งานได้
    window.pokerApp = function() {
        return {
            currentDate: new Date().toISOString().split('T')[0],
            allData: {},
            currentSession: { players: [], rake: 0 },

            init() {
                // ฟังข้อมูลจาก Firebase แบบ Real-time
                const dbRef = ref(db, 'poker_db');
                onValue(dbRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        // อัปเดตข้อมูลทั้งหมดจาก Cloud ลงเครื่อง
                        this.allData = data;
                        this.loadSession();
                    } else {
                        // ถ้ายังไม่มีข้อมูลใน Cloud ให้เริ่มด้วยค่าว่าง
                        this.allData = {};
                        this.loadSession();
                    }
                });
            },

            loadSession() {
                this.currentSession = this.allData[this.currentDate] || { players: [], rake: 0 };
            },

            changeDate() { 
                this.loadSession(); 
            },

            // บันทึกข้อมูลขึ้น Cloud
            save() {
                // อัปเดตข้อมูลวันที่ปัจจุบันเข้าไปในก้อนใหญ่
                this.allData[this.currentDate] = JSON.parse(JSON.stringify(this.currentSession));
                // ยิงขึ้น Firebase
                set(ref(db, 'poker_db'), this.allData);
            },

            addPlayer() {
                if (!this.currentSession.players) this.currentSession.players = [];
                this.currentSession.players.push({ 
                    name: '', 
                    buyins: [{ amount: 0, isPaid: false }], 
                    cashout: 0 
                });
                this.save();
            },

            removePlayer(index) {
                if(confirm('Remove this player?')) { 
                    this.currentSession.players.splice(index, 1); 
                    this.save(); 
                }
            },

            addBuyin(pIdx) {
                if (!this.currentSession.players[pIdx].buyins) this.currentSession.players[pIdx].buyins = [];
                this.currentSession.players[pIdx].buyins.push({ amount: 0, isPaid: false });
                this.save();
            },

            removeBuyin(pIdx, bIdx) {
                this.currentSession.players[pIdx].buyins.splice(bIdx, 1);
                this.save();
            },

            sumPlayerBuyin(p) { 
                if (!p.buyins) return 0;
                return p.buyins.reduce((s, b) => s + (Number(b.amount) || 0), 0); 
            },
            
            getTotalBuyin() { 
                if (!this.currentSession.players) return 0;
                return this.currentSession.players.reduce((s, p) => s + this.sumPlayerBuyin(p), 0); 
            },
            
            getTotalCashout() { 
                if (!this.currentSession.players) return 0;
                return this.currentSession.players.reduce((s, p) => s + (Number(p.cashout) || 0), 0); 
            },
            
            isBalanced() { 
                return this.getTotalBuyin() === (this.getTotalCashout() + (Number(this.currentSession.rake) || 0)); 
            },
            
            formatMoney(v) { return new Intl.NumberFormat('th-TH').format(v); },

            getCustomerHistory() {
                const history = {};
                Object.values(this.allData).forEach(session => {
                    if (!session || !session.players) return;
                    session.players.forEach(p => {
                        if (!p.name) return;
                        const name = p.name.trim();
                        const pBuyin = this.sumPlayerBuyin(p);
                        const pPL = (Number(p.cashout) || 0) - pBuyin;
                        if (!history[name]) history[name] = { name: name, sessions: 0, totalBuyin: 0, totalPL: 0 };
                        history[name].sessions += 1;
                        history[name].totalBuyin += pBuyin;
                        history[name].totalPL += pPL;
                    });
                });
                return Object.values(history).sort((a, b) => b.totalPL - a.totalPL);
            },

            exportAllDataToExcel() {
                const wb = XLSX.utils.book_new();
                const dailySummary = Object.keys(this.allData).map(date => {
                    const session = this.allData[date];
                    const totalIn = session.players ? session.players.reduce((sum, p) => sum + this.sumPlayerBuyin(p), 0) : 0;
                    const totalOut = session.players ? session.players.reduce((sum, p) => sum + (Number(p.cashout) || 0), 0) : 0;
                    return {
                        "วันที่": date,
                        "จำนวนผู้เล่น": session.players ? session.players.length : 0,
                        "Total Buy-in": totalIn,
                        "Total Cash-out": totalOut,
                        "Rake (กำไรบ้าน)": session.rake || 0,
                        "สถานะเงิน": (totalIn === totalOut + (session.rake || 0)) ? "สมดุล" : "ไม่ตรง"
                    };
                });
                const ws1 = XLSX.utils.json_to_sheet(dailySummary);
                XLSX.utils.book_append_sheet(wb, ws1, "ภาพรวมทุกวัน");
                XLSX.writeFile(wb, "Poker_Database_Full_Export.xlsx");
            }
        }
    }
</script>